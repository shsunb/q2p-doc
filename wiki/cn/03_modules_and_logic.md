# 模块功能与逻辑

---

## 1. - 配置管理模块

`config.go` 文件主要用于定义系统的全局配置，包括最大连接数等。它通过提供一个配置函数 `Set_connection_num()`，允许开发者灵活地调整系统的连接限制。

### 功能说明
- **`connection_num`**：最大连接数，限制同时连接的节点数量。
- **`Set_connection_num(num int)`**：设置最大连接数。

### 逻辑
- 系统启动时，`config.go` 提供了默认的最大连接数（32），但可以通过 `Set_connection_num()` 动态调整。
- 在节点处理连接时，`connection_num` 被用于判断当前连接数是否达到上限，从而决定是否与新节点连接。

---

## 2. - 事件定义模块

`event.go` 文件定义了网络中常见的事件类型。这些事件是节点间通信的基础，用于表示不同的网络事件。

### 网络事件类型说明
#### 协议层
- **`JOIN`**：当节点请求加入网络时，当前节点作为种子节点会向已连接节点发送TOUCHREQUEST消息，以帮助新节点打洞。
- **`TOUCHREQUEST`**：当节点请求建立连接时，种子节点会发送目标节点的UDP地址，当前节点随后向该地址打洞并向种子节点发送TOUCHED消息确认。
- **`TOUCH`**：该协议主要通过种子节点帮助新节点打洞以建立连接，尽管首次打洞可能因路由拦截而无法收到确认消息。
- **`TOUCHED`**：当节点收到TOUCHED事件时，它会向打洞目标节点发送CONNECTREQUEST消息，请求连接该打洞节点。
- **`CONNECTREQUEST`**：收到网络事件后，当前节点得知打洞节点已开启端口，随后应向打洞节点发送CONNECT消息以建立连接。
- **`CONNECT`**：当打洞节点接收到目标节点的连接请求时，它会回复CONNECTED消息并将目标节点加入已连接列表。
- **`CONNECTED`**：收到CONNECTED消息后，该节点将对方节点加入已连接列表。

#### 传输层
- **`TRANSPORT`**：节点开始数据传输。
- **`TRANSPORT_FAILED`**：数据传输失败。
  

### 逻辑
- 这些事件常量用于标识节点间的不同网络事件。在处理每个事件时，系统会调用相应的函数，执行具体的操作。

---

## 3. - 节点管理模块

`peer.go` 文件定义了 `Peer_T` 结构和与其他节点的连接管理方法。每个节点都通过 `Peer_T` 类型来表示，并且能够处理各种网络请求。

### 核心功能
- **节点结构**：`Peer_T` 包含节点的 IP 地址、端口、种子节点列表、网络 ID、UDP 连接对象、丢包检查反馈时间、超时时间、传输完毕回调函数和错误反馈回调函数。
- **节点连接**：通过 `*Peer_T.Run` 函数启动节点并监听连接请求。
- **数据收发**：通过 `*Peer_T.Transport` 函数发送完整数据。
                通过 `*Peer_T.TransportAPacket` 函数发送单个数据包。

### 逻辑
- **创建和启动节点**：节点在启动时会创建一个 UDP 监听器，并开始监听来自其他节点的请求。节点通过事件类型来判断如何处理接收到的数据。
- **事件驱动**：每个网络事件（如 `JOIN`、`TOUCHREQUEST`）都由不同的方法处理。这些方法包括 `join()`、`TouchRequest()`、`ConnectRequest()` 等。
- **回调机制**：数据收发过程中，节点会根据接收到的数据触发相应的回调函数进行处理。

---

## 4. - 测试模块

`q2p_test.go` 文件用于测试整个 P2P 网络通信流程，模拟节点间的连接和数据传输过程，确保系统的正常运行。

### 核心功能
- **测试连接**：模拟两个节点之间的连接请求，并验证连接是否成功。
- **数据传输测试**：模拟数据的发送和接收，并验证数据是否按预期传输。

### 逻辑
- **事件模拟**：通过 `TestQ2P()` 和 `TestTransport()` 等测试函数，模拟不同的事件（如节点连接、数据传输）并验证系统的响应。
- **回调验证**：通过回调函数来验证数据的正确性，确保数据传输无误。

---

## 小结

`Q2P` 系统由多个模块组成，模块功能包括连接管理、数据传输、错误处理等，模块间通过事件驱动和回调机制高效地协作，保证了系统的可靠性和灵活性。

---

## 跳转

继续阅读了解更多关于系统模块与功能逻辑的细节：[**连接与通信流程**](04_connection_and_communication.md)。
