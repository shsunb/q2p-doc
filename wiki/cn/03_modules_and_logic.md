# 模块功能与逻辑

---

## 1. `config.go` - 配置管理模块

`config.go` 文件主要用于定义系统的全局配置，包括最大连接数等。它通过提供一个配置函数 `Set_connection_num()`，允许开发者灵活地调整系统的连接限制。

### 功能说明
- **`connection_num`**：最大连接数，限制同时连接的节点数量。
- **`Set_connection_num(num int)`**：设置最大连接数。

### 逻辑
- 系统启动时，`config.go` 提供了默认的最大连接数（32），但可以通过 `Set_connection_num()` 动态调整。
- 在节点处理连接时，`connection_num` 被用于判断当前连接数是否达到上限，从而决定是否与新节点连接。

---

## 2. `event.go` - 事件定义模块

`event.go` 文件定义了网络中常见的事件类型。这些事件是节点间通信的基础，用于表示不同的网络事件。

### 网络事件类型说明
#### 协议层
- **`JOIN`**：节点请求加入网络。当前节点收到来访节点的网络事件为JOIN时，则当前节点作为种子节点来访加入网络所需的种子节点，并且要求每个已连接的节点，向新进节点打洞。所以会向每个已连接发送TOUCHREQUEST消息，并且将新节点作为数据参数传输
- **`TOUCHREQUEST`**：节点请求建立连接。此网络事件应由种子节点发出，数据作为要TOUCH的节点的UDP地址，当前地址收到后，开始向要TOUCH的UDP开始打洞（发送TOUCH消息），并且向种子节点发送一个TOUCHED的网络消息，表示本节点已经按照种子节点的建议向目标节点打洞了。这里touch的动作就是打洞
- **`TOUCH`**：该事件不一定会收到，因为如果是第一次访问新节点，是一个向外打洞的动作，也就是帮助新节点能够连到自身，而这个第一次访问新节点的动作，实际上会被对方节点的外层路由拦下，但是对方节点如果直接暴露在公网，就可以收到，但是这种情况下也就不需要打洞了。无论是否收到该网络事件，都不会有任何实质性的动作，这只是一个历程标志。
- **`TOUCHED`**：该节点收到TOUCHED网络事件时，说明是作为种子节点，被打洞节点告知已经向目标节点打过洞了。该种子节点收到TOUCHED消息后，会向打洞目标节点发送一个CONNECTREQUEST消息，要求打洞目标节点去连接打洞节点
- **`CONNECTREQUEST`**：该节点收到网络事件时，说明种子节点知道当前节点被打过洞后，打洞节点通过TOUCH打洞，已经向该节点开启端口了，所以告知当前节点可以连接打洞节点了。收到该节点后，应该向打洞节点发送CONNECT消息，进行连接
- **`CONNECT`**：该节点作为打洞节点，被打洞目标节点连接时，收到的网络事件，收到该事件后，将回复给打洞目标节点一个CONNECTED消息，并将打洞目标节点，加入已连接中。
- **`CONNECTED`**：该节点收到CONNECTED消息，讲对方节点加入已连接中。


#### 传输层
- **`TRANSPORT`**：节点开始数据传输。
- **`TRANSPORT_FAILED`**：数据传输失败。
  

### 逻辑
- 这些事件常量用于标识节点间的不同网络事件。在处理每个事件时，系统会调用相应的函数，执行具体的操作。

---

## 3. `peer.go` - 节点管理模块

`peer.go` 文件定义了 `Peer_T` 结构和与其他节点的连接管理方法。每个节点都通过 `Peer_T` 类型来表示，并且能够处理各种网络请求。

### 核心功能
- **节点结构**：`Peer_T` 包含节点的 IP 地址、端口、远程种子、网络 ID、UDP 连接对象和回调函数等信息。
- **节点连接**：通过 `Run()` 方法启动节点并监听连接请求。
- **数据收发**：通过 `read()` 方法接收来自其他节点的数据，并通过事件类型进行处理。

### 逻辑
- **创建和启动节点**：节点在启动时会创建一个 UDP 监听器，并开始监听来自其他节点的请求。节点通过事件类型来判断如何处理接收到的数据。
- **事件驱动**：每个网络事件（如 `JOIN`、`TOUCHREQUEST`）都由不同的方法处理。这些方法包括 `join()`、`TouchRequest()`、`ConnectRequest()` 等。
- **回调机制**：数据收发过程中，节点会根据接收到的数据触发相应的回调函数进行处理。

---

## 4. `q2p.go` - 网络事件处理模块

`q2p.go` 文件是 `Q2P` 系统的核心，负责处理网络中的各种事件逻辑，包括数据传输、连接管理、错误处理等。

### 核心功能
- **事件分发**：通过 `networking()` 方法根据事件类型执行不同的操作，如数据传输、连接请求等。
- **数据传输**：在处理 `TRANSPORT` 事件时，`q2p.go` 会通过 `Transport()` 方法进行数据的分片和发送。
- **连接管理**：在 `CONNECTREQUEST` 和 `CONNECT` 事件中，节点之间会建立和确认连接。

### 逻辑
- **事件调度**：通过 `switch` 语句，根据不同的事件类型（如 `JOIN`、`TRANSPORT` 等）调用相应的处理方法。
- **数据处理**：在数据传输过程中，节点通过 `Transport()` 方法对数据进行分片并发送。成功传输后，数据会通过回调函数返回给发送方。

---

## 5. `transmission.go` - 数据传输模块

`transmission.go` 文件负责实现数据的分片、发送、接收和重试机制。它保证了即使在网络不稳定的情况下，数据也能可靠地传输。

### 核心功能
- **数据分片**：将大数据包分割成多个小包进行传输，每个小包最大为 484 字节。
- **超时控制**：如果数据传输超时，系统会触发超时处理逻辑并重新发送。

### 逻辑
- **分片传输**：`Transport()` 方法根据数据的大小，将数据拆分为多个片段，并依次发送。
- **传输监控**：使用 `transmissionSending()` 和 `transmissionReceiving()` 方法来监控数据的发送和接收状态。如果超时或丢失数据包，则会触发失败消息通知机制。

---

## 6. `q2p_test.go` - 测试模块

`q2p_test.go` 文件用于测试整个 P2P 网络通信流程，模拟节点间的连接和数据传输过程，确保系统的正常运行。

### 核心功能
- **测试连接**：模拟两个节点之间的连接请求，并验证连接是否成功。
- **数据传输测试**：模拟数据的发送和接收，并验证数据是否按预期传输。

### 逻辑
- **事件模拟**：通过 `TestQ2P()` 和 `TestTransport()` 等测试函数，模拟不同的事件（如节点连接、数据传输）并验证系统的响应。
- **回调验证**：通过回调函数来验证数据的正确性，确保数据传输无误。

---

## 小结

`Q2P` 系统由多个模块组成，模块功能包括连接管理、数据传输、错误处理等，模块间通过事件驱动和回调机制高效地协作，保证了系统的可靠性和灵活性。

---

## 跳转

继续阅读了解更多关于系统模块与功能逻辑的细节：[**连接与通信流程**](04_connection_and_communication.md)。
