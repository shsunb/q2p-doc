# 连接与通信流程

---

在 `Q2P` 系统中，节点之间的连接和通信是通过 UDP 协议实现的，系统采用事件驱动模型来管理连接请求、数据传输等操作。本文将详细介绍节点连接的流程、各类通信事件的处理机制，以及数据如何在节点之间传递。

## 1. 节点连接流程

### 节点启动

当一个节点启动时，它首先会创建一个 UDP 监听器，并绑定到指定的 IP 地址和端口。节点使用该监听器来接收来自其他节点的请求。

1. **创建 UDP 监听器**：通过 `net.ListenUDP` 创建一个监听器，监听特定的端口。
2. **设置 `NetworkID`**：每个节点会设置一个唯一的 `NetworkID`，用于区分不同的 P2P 网络。
3. **开始监听连接请求**：节点进入监听状态，等待来自其他节点的连接请求。

### 加入网络

当节点启动并监听端口后，它会向网络中的远程节点（通常是种子节点）发送 `JOIN` 请求，表示自己想加入该网络。

1. **发送 `JOIN` 请求**：节点向远程种子节点发送 `JOIN` 消息，告知它们自己的存在。
2. **推送当前节点信息**：收到 `JOIN` 请求的种子节点会将自己已经连接的其他节点信息返回给请求节点。
3. **检查最大连接数**：节点在加入网络时会检查当前连接数是否已超过最大限制，如果未超过，则允许连接，否则拒绝。

### 建立连接

节点之间的连接是通过 `CONNECTREQUEST` 和 `CONNECT` 消息来完成的。连接建立后，数据传输才会开始。

1. **发送 `CONNECTREQUEST` 请求**：节点请求与另一个节点建立连接。
2. **目标节点响应 `CONNECT`**：目标节点确认连接请求，并返回 `CONNECT` 消息。
3. **确认连接成功**：连接双方确认后，标记为已连接，并开始数据传输。

### 数据传输

连接建立后，节点就可以开始进行数据传输。数据传输是通过 `TRANSPORT` 消息来进行的，系统会将大数据分割为多个小包进行传输。

1. **分片数据**：大数据被拆分成多个小包，每个包携带序号（SYN）以便接收方正确组装数据。
2. **重试机制**：如果某些数据包丢失，接收方会要求重新传输丢失的包。
3. **超时处理**：如果数据包在规定时间内未收到，系统会触发超时机制并进行重传。

## 2. 事件驱动机制

`Q2P` 使用事件驱动模型来处理节点之间的通信。在节点之间的交互中，每个事件（如 `JOIN`、`CONNECTREQUEST`、`TRANSPORT` 等）都会触发相应的处理逻辑。以下是常见事件的描述和处理流程。

### `JOIN` 事件

- **触发条件**：节点发送 `JOIN` 请求，表示加入网络。
- **处理逻辑**：远程种子节点返回自己已知的节点信息，并检查当前连接数是否超限。
- **连接管理**：如果连接数未达到最大限制，允许节点加入并返回连接确认消息。

### `CONNECTREQUEST` 和 `CONNECT` 事件

- **触发条件**：节点发送 `CONNECTREQUEST` 请求，试图与目标节点建立连接。
- **处理逻辑**：目标节点返回 `CONNECT` 消息，确认连接建立。
- **连接确认**：两节点确认连接后，进入数据传输阶段。

### `TRANSPORT` 事件

- **触发条件**：节点需要发送数据时触发 `TRANSPORT` 事件。
- **处理逻辑**：数据会被分片成多个小包进行传输，并为每个数据包添加序号（SYN）。
- **传输控制**：接收方通过序号将数据包进行重组，并检查是否有丢包。如果丢包，发送方会进行重传。

### `TRANSPORT_FAILED` 事件

- **触发条件**：数据传输过程中出现丢包、超时等问题时，触发该事件。
- **处理逻辑**：发送方会重新传输丢失的数据包，直到所有数据包成功传输。

## 3. 数据包结构

`Q2P` 的数据传输通过分片数据包进行，每个数据包包含了必要的头部信息，如 `NetworkID`、事件类型、数据长度等。以下是数据包的格式：

| 字段         | 描述                          | 长度（字节） |
| ------------ | ----------------------------- | ------------ |
| `NetworkID`  | 网络标识符                    | 2            |
| `Event`      | 事件类型（如 `JOIN`、`CONNECT`） | 2            |
| `Data Length`| 数据长度                      | 4            |
| `Data`       | 数据部分                      | 可变长度     |

### 数据包示例：

1. **`JOIN` 请求包**：

| NetworkID | Event   | Data Length | Data    |
| --------- | ------- | ----------- | ------- |
| 0x1234    | JOIN    | 0x0002      | 无      |


2. **`TRANSPORT` 数据包**：

| NetworkID | Event    | Data Length | Data                                  |
| --------- | -------- | ----------- | ------------------------------------- |
| 0x1234    | TRANSPORT| 0x0014      | 数据包内容（例如：文件的一个片段）  |


## 4. 连接状态与错误处理

在数据传输过程中，如果出现错误（如超时、丢包等），系统会进入错误处理流程：

- **超时**：如果数据传输超时，系统会通过 `TRANSPORT_FAILED` 事件进行处理，并重试丢失的包。
- **传输失败**：如果数据包传输失败，发送方会重新发送数据包，直到成功为止。
- **最大连接数**：每个节点连接的最大数目是有限的，超过限制后新的连接请求将被拒绝。

---

## 结论

`Q2P` 的连接和通信流程采用了事件驱动和回调机制，使得节点间的连接和数据传输变得简洁高效。通过 UDP 协议，系统能够实现高性能的数据传输，并且通过分片和重试机制保证数据的可靠性。同时，系统能够有效地处理各种网络事件，确保节点间的连接顺畅。

---

## 跳转

继续阅读了解更多关于数据传输与分片机制的细节：[**数据传输与分片机制**](05_data_transport_and_fragmentation.md)。
