# 连接与通信流程

---

在 `Q2P` 系统中，节点之间的连接和通信是通过 UDP 协议实现的，系统采用事件驱动模型来管理连接请求、数据传输等操作。本文将详细介绍节点连接的流程、各类通信事件的处理机制，以及数据如何在节点之间传递。

## 1. 节点连接流程

### 节点启动

当一个节点启动时，它首先会创建一个 UDP 监听器，并绑定到指定的 IP 地址和端口。节点使用该监听器来接收来自其他节点的请求。

1. **创建 UDP 监听器**：通过 `net.ListenUDP` 创建一个监听器，监听特定的端口。
2. **设置 `NetworkID`**：每个节点会设置一个唯一的 `NetworkID`，用于区分不同的 P2P 网络。
3. **开始监听连接请求**：节点进入监听状态，等待来自其他节点的连接请求。

### 加入网络

当节点启动并监听端口后，它会向网络中的远程节点（通常是种子节点）发送 `JOIN` 请求，表示自己想加入该网络。

1. **发送 `JOIN` 请求**：节点向远程种子节点发送 `JOIN` 消息，告知它们自己的存在。
2. **推送当前节点信息**：收到 `JOIN` 请求的种子节点会将自己已经连接的其他节点信息返回给请求节点。
3. **检查最大连接数**：节点在加入网络时会检查当前连接数是否已超过最大限制，如果未超过，则允许连接，否则拒绝。

### 建立连接

节点之间的连接是通过 `CONNECTREQUEST` 和 `CONNECT` 消息来完成的。连接建立后，数据传输才会开始。

1. **发送 `CONNECTREQUEST` 请求**：节点请求与另一个节点建立连接。
2. **目标节点响应 `CONNECT`**：目标节点确认连接请求，并返回 `CONNECT` 消息。
3. **确认连接成功**：连接双方确认后，标记为已连接，并开始数据传输。
4. **数据传输**：成功连接后，两个节点可以直接使用 `TRANSPORT` 事件发送数据。

### 数据传输

连接建立后，节点就可以开始进行数据传输。数据传输是通过 `TRANSPORT` 消息来进行的，系统会将大数据分割为多个小包进行传输。

1. **分片数据**：大数据被拆分成多个小包，每个包携带序号（SYN）以便接收方正确组装数据。
2. **重试机制**：如果某些数据包丢失，接收方会导致发送方传输丢失的包，如何处理由发送方决定。
3. **超时处理**：如果数据包在规定时间内未收到，系统会告知发送方超时，如何处理由发送方决定。
4. **传输模式** 成功连接后，两个节点可以直接使用 `TRANSPORT` 事件发送数据。

## 2. 事件驱动机制

`Q2P` 使用事件驱动模型来处理节点之间的通信。在节点之间的交互中，每个事件（如 `JOIN`、`CONNECTREQUEST`、`TRANSPORT` 等）都会触发相应的处理逻辑。以下是常见事件的描述和处理流程。

### `JOIN` 事件

- **触发条件**：节点发送 `JOIN` 消息，表示加入网络。
- **处理逻辑**：远程种子节点返回自己已知的节点信息，并检查当前连接数是否超限。
- **连接管理**：如果连接数未达到最大限制，允许节点加入并返回连接确认消息。

### `CONNECTREQUEST` 和 `CONNECT` 事件

- **触发条件**：节点发送 `CONNECTREQUEST` 消息，试图与目标节点建立连接。
- **处理逻辑**：目标节点返回 `CONNECT` 消息，确认连接建立。
- **连接确认**：两节点确认连接后，进入数据传输阶段。

### `CONNECT_FAILED` 事件

- **触发条件**：节点发送 `CONNECT_FAILED` 消息，表示协议层错误，这通常是 networkID 不一致导致的。
- **处理逻辑**：打印错误

### `TRANSPORT` 事件

- **触发条件**：节点需要发送数据时触发 `TRANSPORT` 事件。
- **处理逻辑**：数据会被分片成多个小包进行传输，并为每个数据包添加序号（SYN）。
- **传输控制**：接收方通过序号将数据包进行重组，并检查是否有丢包，如果丢包或者超时，将通过向发送方传回一个`TRANSPORT_FAILED` 事件消息告知发送方。

### `TRANSPORT_FAILED` 事件

- **触发条件**：数据传输过程中出现丢包、超时等问题时，触发该事件。
- **处理逻辑**：发送方收到该事件，接收方会通过该事件告知发送方传输丢失的数据包或者连接超时，如何处理由发送方决定。

## 3. 数据包结构

`Q2P` 的数据传输通过分片数据包进行，每个数据包包含了必要的头部信息，如 `NetworkID`、事件类型、数据长度等。以下是数据包的格式：

### 协议层数据包结构 ###

| 字段         | 描述                           | 长度（字节） |
| ------------ | ------------------------------ | ------------ |
| `NetworkID`  | 网络标识符                      | 2            |
| `Event`      | 事件类型(如 `JOIN`、`CONNECT`)  | 2            |
| `Data`       | 数据部分                        | 可变长度     |

### 协议层数据包示例：

**`JOIN` 事件包**：

| NetworkID | Event      | Data |
| --------- | -------    | ---- |
| 0x0       | 0x0 (JOIN) |      |
- 该事件属于协议层，所有协议层的事件，本依赖包调用者无需关心

### 传输层数据包结构 ###
- 当协议层事件为 `TRANSPORT` 其Data的内部结构为

| 字段                | 描述        | 长度（字节） |
| ------------------- | ----------- | ------------ |
| `Transmission HASH` | 此传输的HASH | 16          |
| `Data length`       | Body 的长度  | 4           |
| `SYN`               | 包序         | 4           |
| `Body`              | Body         | 可变长度     |


**传输层数据包示例**：

| Transmission HASH | Data length | SYN | Body               |
| ----------------- | ----------- | --- | ------------------ |
| af820482....      | 0x1600      | 1   | 0x5, 0x10, 0xff... |
| af820482....      | 0x1600      | 2   | 0x5, 0x10, 0xff... |
| af820482....      | 0x1600      | 3   | 0x5, 0x10, 0xff... |

- 一个完整的Transmission Data 被分割成若干个body 加入到相应的packet，除最后一个body，每个body的长度为484字节，最后一个body是剩余的字节数据（长度为0 ~ 484之间）



## 4. 连接状态与错误处理

在数据传输过程中，如果出现错误（如超时、丢包等），系统会进入错误处理流程：

- **超时**：如果数据传输超时，系统会通过 `TRANSPORT_FAILED` 事件进行处理，并重试丢失的包。
- **传输失败**：如果数据包传输失败，发送方会重新发送数据包，直到成功为止。
- **最大连接数**：每个节点连接的最大数目是有限的，超过限制后新的连接请求将被拒绝。

## 5. NAT 穿透实现

`q2p`使用了一个基于 UDP 协议的节点模型，支持点对点（P2P）网络通信，并通过以下机制实现 NAT 穿透：

### 种子节点角色
代码中的 `RemoteSeeds`（远程种子）列表类似于 TURN 中的中间服务器，充当了 NAT 穿透的“中间人”角色。每个节点在加入网络时，会向种子节点发送 `JOIN` 请求，表示希望参与通信。

- **功能对应**：
  - `RemoteSeeds` 提供类似 TURN 服务器的功能，用于为新加入的节点建立初始连接。
  - `JOIN` 事件触发时，种子节点将与其建立通信，并帮助它连接到网络中的其他节点。

### 打洞过程
在代码库的 NAT 穿透机制中，通过 `TOUCHREQUEST` 和 `TOUCH` 事件打洞：

### 连接建立与确认
- 与种子节点相连接的新老节点，分别使用 `CONNECT` 和 `CONNECTED` 事件完成两节点之间的直接连接。


---

## 跳转

继续阅读了解更多关于数据传输与分片机制的细节：[**数据传输与分片机制**](05_data_transport_and_fragmentation.md)。
